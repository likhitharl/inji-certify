{
	"info": {
		"_postman_id": "710a0e17-88d9-4686-8332-05dd6045c363",
		"name": "Inji Certify - Pre Auth Code",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "1282483"
	},
	"item": [
		{
			"name": "Well-known endpoints",
			"item": [
				{
					"name": "JWKS",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{certifyurl}}/.well-known/jwks.json",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								".well-known",
								"jwks.json"
							]
						}
					},
					"response": []
				},
				{
					"name": "DID",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{certifyurl}}/.well-known/did.json",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								".well-known",
								"did.json"
							]
						}
					},
					"response": []
				},
				{
					"name": "OAuth-Metadata",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{certifyurl}}/.well-known/oauth-authorization-server",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								".well-known",
								"oauth-authorization-server"
							]
						}
					},
					"response": []
				},
				{
					"name": "VC issuer metadata",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{certifyurl}}/.well-known/openid-credential-issuer",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								".well-known",
								"openid-credential-issuer"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Credential Configuration",
			"item": [
				{
					"name": "Add New Config",
					"request": {
						"auth": {
							"type": "noauth"
						},
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\r\n    \"vcTemplate\": \"ewogICAgICAgICJAY29udGV4dCI6IFsKICAgICAgICAgICAgImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwKICAgICAgICAgICAgImh0dHBzOi8vcGl5dXNoNzAzNC5naXRodWIuaW8vbXktZmlsZXMvZmFybWVyLmpzb24iCiAgICAgICAgXSwKICAgICAgICAiaXNzdWVyIjogIiR7X2lzc3Vlcn0iLAogICAgICAgICJ0eXBlIjogWwogICAgICAgICAgICAiVmVyaWZpYWJsZUNyZWRlbnRpYWwiLAogICAgICAgICAgICAiRmFybWVyQ3JlZGVudGlhbCIKICAgICAgICBdLAogICAgICAgICJpc3N1YW5jZURhdGUiOiAiJHt2YWxpZEZyb219IiwKICAgICAgICAiZXhwaXJhdGlvbkRhdGUiOiAiJHt2YWxpZFVudGlsfSIsCiAgICAgICAgImNyZWRlbnRpYWxTdWJqZWN0IjogewogICAgICAgICAgICAiaWQiOiAiJHtfaG9sZGVySWR9IiwKICAgICAgICAgICAgImZ1bGxOYW1lIjogIiR7ZnVsbE5hbWV9IiwKICAgICAgICAgICAgIm1vYmlsZU51bWJlciI6ICIke3Bob25lfSIsCiAgICAgICAgICAgICJkYXRlT2ZCaXJ0aCI6ICIke2RhdGVPZkJpcnRofSIsCiAgICAgICAgICAgICJnZW5kZXIiOiAiJHtnZW5kZXJ9IgogICAgICAgIH0KICAgIH0=\",\r\n    \"credentialConfigKeyId\": \"FarmerCredential\",\r\n    \"contextURLs\": [\r\n        \"https://www.w3.org/2018/credentials/v1\"\r\n    ],\r\n    \"credentialTypes\": [\r\n        \"FarmerCredential\",\r\n        \"VerifiableCredential\"\r\n    ],\r\n    \"credentialFormat\": \"ldp_vc\",\r\n    \"didUrl\": \"did:web:mosip.github.io:inji-config:vc-local-ed25519\",\r\n    \"keyManagerAppId\": \"CERTIFY_VC_SIGN_ED25519\",\r\n    \"keyManagerRefId\": \"ED25519_SIGN\",\r\n    \"signatureAlgo\": \"EdDSA\",\r\n    \"signatureCryptoSuite\": \"Ed25519Signature2020\",\r\n    \"metaDataDisplay\": [\r\n        {\r\n            \"logo\": {\r\n                \"url\": \"https://mosip.github.io/inji-config/logos/agro-vertias-logo.png\",\r\n                \"alt_text\": \"Farmer Credential Logo\"\r\n            },\r\n            \"name\": \"Farmer Verifiable Credential\",\r\n            \"locale\": \"en\",\r\n            \"text_color\": \"#FFFFFF\",\r\n            \"background_color\": \"#12107c\",\r\n            \"background_image\": {\r\n                \"uri\": \"https://mosip.github.io/inji-config/logos/agro-vertias-logo.png\"\r\n            }\r\n        }\r\n    ],\r\n    \"displayOrder\": [\r\n        \"fullName\",\r\n        \"mobileNumber\",\r\n        \"dateOfBirth\",\r\n        \"gender\",\r\n        \"state\",\r\n        \"district\",\r\n        \"villageOrTown\",\r\n        \"postalCode\",\r\n        \"landArea\",\r\n        \"landOwnershipType\",\r\n        \"primaryCropType\",\r\n        \"secondaryCropType\",\r\n        \"farmerID\"\r\n    ],\r\n    \"scope\": \"mock_identity_vc_ldp\",\r\n    \"pluginConfigurations\": [\r\n        {\r\n            \"mosip.certify.mock.data-provider.csv-registry-uri\": \"/home/mosip/config/farmer_identity_data.csv\",\r\n            \"mosip.certify.mock.data-provider.csv.data-columns\": \"id,fullName,mobileNumber,dateOfBirth,gender,state,district,villageOrTown,postalCode,landArea,landOwnershipType,primaryCropType,secondaryCropType,face,farmerID\",\r\n            \"mosip.certify.mock.data-provider.csv.identifier-column\": \"id\"\r\n        }\r\n    ],\r\n    \"credentialStatusPurposes\": [\r\n        \"revocation\"\r\n    ],\r\n    \"qrSettings\": [\r\n        {\r\n            \"Full Name\": \"${fullName}\",\r\n            \"Phone Number\": \"${mobileNumber}\",\r\n            \"Date Of Birth\": \"${dateOfBirth}\"\r\n        }\r\n    ],\r\n    \"qrSignatureAlgo\": \"EdDSA\",\r\n    \"credentialSubjectDefinition\": {\r\n        \"phone\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Phone Number\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        },\r\n        \"gender\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Gender\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        },\r\n        \"fullName\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Full Name\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        },\r\n        \"dateOfBirth\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Date of Birth\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{certifyurl}}/credential-configurations",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"credential-configurations"
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Configuration By Id",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{certifyurl}}/credential-configurations/{{credential_config_id}}",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"credential-configurations",
								"{{credential_config_id}}"
							]
						}
					},
					"response": []
				},
				{
					"name": "Update Configuration By Id",
					"request": {
						"method": "PUT",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\r\n    \"vcTemplate\": \"ewogICAgICAgICJAY29udGV4dCI6IFsKICAgICAgICAgICAgImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwKICAgICAgICAgICAgImh0dHBzOi8vcGl5dXNoNzAzNC5naXRodWIuaW8vbXktZmlsZXMvZmFybWVyLmpzb24iCiAgICAgICAgXSwKICAgICAgICAiaXNzdWVyIjogIiR7X2lzc3Vlcn0iLAogICAgICAgICJ0eXBlIjogWwogICAgICAgICAgICAiVmVyaWZpYWJsZUNyZWRlbnRpYWwiLAogICAgICAgICAgICAiRmFybWVyQ3JlZGVudGlhbCIKICAgICAgICBdLAogICAgICAgICJpc3N1YW5jZURhdGUiOiAiJHt2YWxpZEZyb219IiwKICAgICAgICAiZXhwaXJhdGlvbkRhdGUiOiAiJHt2YWxpZFVudGlsfSIsCiAgICAgICAgImNyZWRlbnRpYWxTdWJqZWN0IjogewogICAgICAgICAgICAiaWQiOiAiJHtfaG9sZGVySWR9IiwKICAgICAgICAgICAgImZ1bGxOYW1lIjogIiR7ZnVsbE5hbWV9IiwKICAgICAgICAgICAgIm1vYmlsZU51bWJlciI6ICIke3Bob25lfSIsCiAgICAgICAgICAgICJkYXRlT2ZCaXJ0aCI6ICIke2RhdGVPZkJpcnRofSIsCiAgICAgICAgICAgICJnZW5kZXIiOiAiJHtnZW5kZXJ9IgogICAgICAgIH0KICAgIH0=\",\r\n    \"credentialConfigKeyId\": \"FarmerCredential\",\r\n    \"contextURLs\": [\r\n        \"https://www.w3.org/2018/credentials/v1\"\r\n    ],\r\n    \"credentialTypes\": [\r\n        \"FarmerCredential\",\r\n        \"VerifiableCredential\"\r\n    ],\r\n    \"credentialFormat\": \"ldp_vc\",\r\n    \"didUrl\": \"did:web:mosip.github.io:inji-config:vc-local-ed25519\",\r\n    \"keyManagerAppId\": \"CERTIFY_VC_SIGN_ED25519\",\r\n    \"keyManagerRefId\": \"ED25519_SIGN\",\r\n    \"signatureAlgo\": \"EdDSA\",\r\n    \"signatureCryptoSuite\": \"Ed25519Signature2020\",\r\n    \"metaDataDisplay\": [\r\n        {\r\n            \"logo\": {\r\n                \"url\": \"https://mosip.github.io/inji-config/logos/agro-vertias-logo.png\",\r\n                \"alt_text\": \"Farmer Credential Logo\"\r\n            },\r\n            \"name\": \"Farmer Verifiable Credential\",\r\n            \"locale\": \"en\",\r\n            \"text_color\": \"#FFFFFF\",\r\n            \"background_color\": \"#12107c\",\r\n            \"background_image\": {\r\n                \"uri\": \"https://mosip.github.io/inji-config/logos/agro-vertias-logo.png\"\r\n            }\r\n        }\r\n    ],\r\n    \"displayOrder\": [\r\n        \"fullName\",\r\n        \"mobileNumber\",\r\n        \"dateOfBirth\",\r\n        \"gender\",\r\n        \"state\",\r\n        \"district\",\r\n        \"villageOrTown\",\r\n        \"postalCode\",\r\n        \"landArea\",\r\n        \"landOwnershipType\",\r\n        \"primaryCropType\",\r\n        \"secondaryCropType\",\r\n        \"farmerID\"\r\n    ],\r\n    \"scope\": \"mock_identity_vc_ldp\",\r\n    \"pluginConfigurations\": [\r\n        {\r\n            \"mosip.certify.mock.data-provider.csv-registry-uri\": \"/home/mosip/config/farmer_identity_data.csv\",\r\n            \"mosip.certify.mock.data-provider.csv.data-columns\": \"id,fullName,mobileNumber,dateOfBirth,gender,state,district,villageOrTown,postalCode,landArea,landOwnershipType,primaryCropType,secondaryCropType,face,farmerID\",\r\n            \"mosip.certify.mock.data-provider.csv.identifier-column\": \"id\"\r\n        }\r\n    ],\r\n    \"credentialStatusPurposes\": [\r\n        \"revocation\"\r\n    ],\r\n    \"qrSettings\": [\r\n        {\r\n            \"Full Name\": \"${fullName}\",\r\n            \"Phone Number\": \"${mobileNumber}\",\r\n            \"Date Of Birth\": \"${dateOfBirth}\"\r\n        }\r\n    ],\r\n    \"qrSignatureAlgo\": \"EdDSA\",\r\n    \"credentialSubjectDefinition\": {\r\n        \"phone\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Phone Number\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        },\r\n        \"gender\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Gender\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        },\r\n        \"fullName\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Full Name\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        },\r\n        \"dateOfBirth\": {\r\n            \"display\": [\r\n                {\r\n                    \"name\": \"Date of Birth\",\r\n                    \"locale\": \"en\"\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{certifyurl}}/credential-configurations/{{credential_config_id}}",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"credential-configurations",
								"{{credential_config_id}}"
							]
						}
					},
					"response": []
				},
				{
					"name": "Delete Configuration By Id Copy",
					"request": {
						"method": "DELETE",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{certifyurl}}/credential-configurations/{{credential_config_id}}",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"credential-configurations",
								"{{credential_config_id}}"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Pre-Authorized Code Flow",
			"item": [
				{
					"name": "1. Generate Pre-Authorized Code",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has credential_offer_uri\", function () {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.credential_offer_uri).to.be.a('string');",
									"    const uri = jsonData.credential_offer_uri;",
									"    const offerId = uri.split('%2F').pop();",
									"    console.log('Extracted offer_id: ' + offerId);",
									"    pm.collectionVariables.set('offer_id', offerId);",
									"   ",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"credential_configuration_id\": \"{{credential_config_id}}\",\n    \"claims\": {\n        \"fullName\": \"John Doe\",\n        \"dateOfBirth\": \"1990-01-15\",\n        \"gender\": \"Male\",\n        \"phone\": \"+1234567890\"\n    },\n    \"expires_in\": 600,\n    \"tx_code\": \"{{pre_auth_tx_code}}\"\n}"
						},
						"url": {
							"raw": "{{certifyurl}}/pre-authorized-data",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"pre-authorized-data"
							]
						}
					},
					"response": []
				},
				{
					"name": "2. Get Credential Offer",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Response has grants with pre-authorized_code\", function () {",
									"    const jsonData = pm.response.json();",
									"    const grants = jsonData.grants;",
									"    pm.expect(grants).to.be.an('object');",
									"    const preAuthGrant = grants['urn:ietf:params:oauth:grant-type:pre-authorized_code'];",
									"    pm.expect(preAuthGrant).to.be.an('object');",
									"    pm.expect(preAuthGrant['pre-authorized_code']).to.be.a('string');",
									"    const preAuthCode = preAuthGrant['pre-authorized_code'];",
									"    console.log(\"Extracted pre-authorized_code:\", preAuthCode);",
									"    pm.collectionVariables.set('pre_authorized_code', preAuthCode);",
									"    ",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{certifyurl}}/credential-offer-data/{{offer_id}}",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"credential-offer-data",
								"{{offer_id}}"
							]
						}
					},
					"response": []
				},
				{
					"name": "3. Exchange Code for Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Token exchange successful', function () {",
									"    pm.response.to.have.status(200);",
									"",
									"    console.log(\"Tests executed\");",
									"",
									"    var jsonData = pm.response.json();",
									"",
									"    // Verify important properties exist",
									"    pm.expect(jsonData).to.have.property('access_token');",
									"    pm.expect(jsonData).to.have.property('token_type');",
									"    pm.expect(jsonData).to.have.property('expires_in');",
									"    pm.expect(jsonData).to.have.property('c_nonce');",
									"    pm.expect(jsonData).to.have.property('c_nonce_expires_in');",
									"",
									"    const accessToken = jsonData.access_token;",
									"    // Store access token",
									"    console.log(\"access_token:\", accessToken);",
									"    pm.collectionVariables.set('access_token', accessToken);",
									"    console.log(\"âœ… Access token saved successfully\");",
									"    const cNonce = jsonData.c_nonce;",
									"    const cNonceExpiresIn = jsonData.c_nonce_expires_in;",
									"    pm.collectionVariables.set('c_nonce', cNonce);",
									"    pm.collectionVariables.set('c_nonce_expires_in', cNonceExpiresIn);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/x-www-form-urlencoded"
							}
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{
									"key": "grant_type",
									"value": "urn:ietf:params:oauth:grant-type:pre-authorized_code",
									"type": "text"
								},
								{
									"key": "pre-authorized_code",
									"value": "{{pre_authorized_code}}",
									"type": "text"
								},
								{
									"key": "tx_code",
									"value": "{{pre_auth_tx_code}}",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{certifyurl}}/oauth/token",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"oauth",
								"token"
							]
						}
					},
					"response": []
				},
				{
					"name": "4. Get Credential with Pre-Auth Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200 or 201\", function () {",
									"    pm.expect(pm.response.code).to.be.oneOf([200, 201]);",
									"});",
									"",
									"pm.test(\"Response has credential\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.credential).to.exist;",
									"    console.log('Credential received successfully');",
									"});"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"eval(pm.globals.get('pmlib_code'))",
									"keyPair = pmlib.rs.KEYUTIL.generateKeypair(\"RSA\", 2048);",
									"jwkPrivateKey = pmlib.rs.KEYUTIL.getJWK(keyPair.prvKeyObj);",
									"jwkPublicKey  = pmlib.rs.KEYUTIL.getJWK(keyPair.pubKeyObj);",
									"jwkPublicKey[\"alg\"] = \"RS256\";",
									"jwkPublicKey[\"use\"] = \"sig\";",
									"",
									"pm.collectionVariables.set(\"holder_public_key\", JSON.stringify(jwkPublicKey))",
									"pm.collectionVariables.set(\"holder_private_key\", JSON.stringify(jwkPrivateKey));",
									"",
									"// Set headers for JWT",
									"var header = {\t",
									"\t\"alg\": \"RS256\",",
									"    \"typ\" : \"openid4vci-proof+jwt\",",
									"    \"jwk\" : JSON.parse(pm.collectionVariables.get(\"holder_public_key\"))",
									"};",
									"",
									"",
									"console.log(\"Getting c_nonce >> \" +  pm.collectionVariables.get('c_nonce'));",
									"",
									"const signed_jwt = pmlib.jwtSign(JSON.parse(pm.collectionVariables.get(\"holder_private_key\")), {",
									"    \"aud\" : pm.environment.get('audUrl'),",
									"\t\"nonce\": pm.collectionVariables.get('c_nonce'),",
									"    \"iss\" : \"\",",
									"}, header, exp=600, alg = \"RS256\")",
									"",
									"pm.collectionVariables.set(\"proof_jwt\",signed_jwt);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{access_token}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"format\": \"ldp_vc\",\n    \"credential_definition\": {\n        \"@context\": [\n            \"https://www.w3.org/2018/credentials/v1\"\n        ],\n        \"type\": [\n            \"VerifiableCredential\",\n            \"FarmerCredential\"\n        ]\n    },\n    \"proof\": {\n        \"proof_type\": \"jwt\",\n        \"jwt\": \"{{proof_jwt}}\"\n    }\n}"
						},
						"url": {
							"raw": "{{certifyurl}}/issuance/credential",
							"host": [
								"{{certifyurl}}"
							],
							"path": [
								"issuance",
								"credential"
							]
						}
					},
					"response": []
				}
			]
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "offer_id",
			"value": ""
		},
		{
			"key": "pre_authorized_code",
			"value": ""
		},
		{
			"key": "access_token",
			"value": ""
		},
		{
			"key": "c_nonce",
			"value": ""
		},
		{
			"key": "c_nonce_expires_in",
			"value": ""
		},
		{
			"key": "proof_jwt",
			"value": ""
		},
		{
			"key": "holder_public_key",
			"value": ""
		},
		{
			"key": "holder_private_key",
			"value": ""
		}
	]
}